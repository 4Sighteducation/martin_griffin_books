---
export interface Slide {
  image: string;
  alt: string;
  caption?: string;
}

export interface Props {
  slides: Slide[];
  autoplay?: boolean;
  interval?: number;
}

const { slides, autoplay = true, interval = 4000 } = Astro.props;
const slideshowId = `slideshow-${Math.random().toString(36).substr(2, 9)}`;
---

<div class="relative w-full max-w-2xl mx-auto" id={slideshowId}>
  <!-- Slideshow Container -->
  <div class="relative overflow-hidden rounded-lg shadow-2xl aspect-[2/3]">
    {slides.map((slide, index) => (
      <div 
        class={`slide absolute inset-0 transition-opacity duration-700 ease-in-out ${index === 0 ? 'opacity-100' : 'opacity-0'}`}
        data-slide-index={index}
      >
        <img 
          src={slide.image} 
          alt={slide.alt}
          class="w-full h-full object-contain bg-gray-100"
          loading={index === 0 ? 'eager' : 'lazy'}
        />
        {slide.caption && (
          <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-4">
            <p class="text-white text-sm font-medium text-center">{slide.caption}</p>
          </div>
        )}
      </div>
    ))}
  </div>

  <!-- Navigation Arrows -->
  {slides.length > 1 && (
    <>
      <button 
        class="prev-btn absolute left-2 top-1/2 -translate-y-1/2 bg-white/90 hover:bg-white text-gray-800 rounded-full p-3 shadow-lg transition-all hover:scale-110 z-10"
        aria-label="Previous slide"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>
      <button 
        class="next-btn absolute right-2 top-1/2 -translate-y-1/2 bg-white/90 hover:bg-white text-gray-800 rounded-full p-3 shadow-lg transition-all hover:scale-110 z-10"
        aria-label="Next slide"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </>
  )}

  <!-- Dots Indicator -->
  {slides.length > 1 && (
    <div class="flex justify-center gap-2 mt-4">
      {slides.map((_, index) => (
        <button
          class={`dot w-3 h-3 rounded-full transition-all ${index === 0 ? 'bg-primary-600 w-8' : 'bg-gray-300 hover:bg-gray-400'}`}
          data-dot-index={index}
          aria-label={`Go to slide ${index + 1}`}
        />
      ))}
    </div>
  )}
</div>

<script define:vars={{ slideshowId, autoplay, interval, slidesCount: slides.length }}>
  if (slidesCount > 1) {
    const container = document.getElementById(slideshowId);
    const slides = container.querySelectorAll('.slide');
    const dots = container.querySelectorAll('.dot');
    const prevBtn = container.querySelector('.prev-btn');
    const nextBtn = container.querySelector('.next-btn');
    let currentSlide = 0;
    let autoplayTimer;

    function showSlide(n) {
      currentSlide = (n + slidesCount) % slidesCount;
      
      slides.forEach((slide, index) => {
        slide.style.opacity = index === currentSlide ? '1' : '0';
      });
      
      dots.forEach((dot, index) => {
        if (index === currentSlide) {
          dot.classList.add('bg-primary-600', 'w-8');
          dot.classList.remove('bg-gray-300');
        } else {
          dot.classList.remove('bg-primary-600', 'w-8');
          dot.classList.add('bg-gray-300');
        }
      });
    }

    function nextSlide() {
      showSlide(currentSlide + 1);
      resetAutoplay();
    }

    function prevSlide() {
      showSlide(currentSlide - 1);
      resetAutoplay();
    }

    function resetAutoplay() {
      if (autoplay) {
        clearInterval(autoplayTimer);
        autoplayTimer = setInterval(nextSlide, interval);
      }
    }

    // Event listeners
    prevBtn?.addEventListener('click', prevSlide);
    nextBtn?.addEventListener('click', nextSlide);
    
    dots.forEach((dot, index) => {
      dot.addEventListener('click', () => {
        showSlide(index);
        resetAutoplay();
      });
    });

    // Start autoplay
    if (autoplay) {
      autoplayTimer = setInterval(nextSlide, interval);
    }

    // Pause on hover
    container.addEventListener('mouseenter', () => {
      if (autoplay) clearInterval(autoplayTimer);
    });
    
    container.addEventListener('mouseleave', () => {
      if (autoplay) autoplayTimer = setInterval(nextSlide, interval);
    });
  }
</script>
